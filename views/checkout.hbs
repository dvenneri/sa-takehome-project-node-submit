<div class="row justify-content-md-center">
  <div class="col-6">
    <div class="text-center mt-40">
      <h1>
        Checkout â€” Stripe Press
      </h1>
      {{#if error}}
        <p class="text-danger">{{error}}</p>
      {{else}}
        <h5 class="text-secondary">
          {{title}}
        </h5>
        <hr class="mt-40">
        <div class="mt-20 text-info">
          Total due: ${{displayAmount}}
        </div>
      {{/if}}
    </div>

    {{#unless error}}
      <div class="card box-shadow mt-40">
        <div class="card-body">
          <form id="payment-form">
            <div id="payment-element" class="mt-20">
              <!-- Stripe Payment Element will be injected here -->
            </div>

            <div class="mt-20">
              <button id="submit" type="submit" class="btn btn-lg btn-block btn-primary">
                Pay ${{displayAmount}}
              </button>
            </div>

            <div id="payment-message" class="mt-20 text-danger"></div>
          </form>
        </div>
      </div>
    {{/unless}}
  </div>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
  const stripe = Stripe('{{publishableKey}}');
  const item = '{{item}}';
  const amount = {{amount}}; // cents

  let elements;

  // 1. Create a PaymentIntent and mount the Payment Element
  async function initialize() {
    const res = await fetch('/create-payment-intent', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ item })
    });

    const data = await res.json();

    elements = stripe.elements({ clientSecret: data.clientSecret });
    const paymentElement = elements.create('payment');
    paymentElement.mount('#payment-element');
  }

  initialize();

  // 2. Confirm the payment on form submit
  const form = document.getElementById('payment-form');
  form.addEventListener('submit', async (event) => {
    event.preventDefault();

    const { error, paymentIntent } = await stripe.confirmPayment({
      elements,
      redirect: 'if_required'
    });

    if (error) {
      document.getElementById('payment-message').textContent = error.message;
    } else if (paymentIntent && paymentIntent.status === 'succeeded') {
      window.location.href = `/success?payment_intent=${paymentIntent.id}&amount=${amount}`;
    } else {
      document.getElementById('payment-message').textContent = 'Unexpected payment state.';
    }
  });
</script>
